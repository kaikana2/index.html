<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base href="./">
  <title>あなたの考え方のクセを知ろうテスト</title>

  <!-- Radar chart (CDN). If you want to bundle it, download chart.umd.min.js and change to: <script src="./chart.umd.min.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --text:#eef2ff;
      --muted:#b8c1ff;
      --accent:#7c9dff;
      --accent2:#67e8f9;
      --danger:#fb7185;
      --ok:#34d399;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
                   "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;
      background: radial-gradient(1200px 800px at 70% -10%, rgba(124,157,255,.25), transparent 60%),
                  radial-gradient(900px 700px at -10% 20%, rgba(103,232,249,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding:18px 18px 10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    header .title{
      font-weight:800;
      letter-spacing:.02em;
      font-size:18px;
      margin:0;
    }
    header .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    main{ padding:18px; }
    .card{
      background: rgba(18,26,51,.75);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .spacer{ height:12px; }

    .btn{
      appearance:none;
      border:none;
      border-radius: 14px;
      padding:12px 14px;
      font-weight:700;
      color:var(--text);
      background: linear-gradient(135deg, rgba(124,157,255,.95), rgba(103,232,249,.75));
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(124,157,255,.18);
      width:100%;
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.08);
      box-shadow:none;
      border:1px solid var(--border);
    }
    .btn.danger{
      background: rgba(251,113,133,.16);
      border:1px solid rgba(251,113,133,.35);
      box-shadow:none;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.8);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
      font-weight:700;
    }
    .qtext{
      font-size:18px;
      line-height:1.6;
      margin:10px 0 0;
      font-weight:750;
    }
    .choices{
      display:grid;
      gap:10px;
      margin-top:14px;
    }
    .choice{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:12px 12px;
      display:flex;
      align-items:flex-start;
      gap:10px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .choice:hover{ background: rgba(255,255,255,.06); }
    .choice input{ margin-top:3px; }
    .choice.selected{
      border-color: rgba(124,157,255,.65);
      background: rgba(124,157,255,.12);
    }
    .choice .label{
      font-weight:700;
      line-height:1.35;
    }
    .choice .small{
      display:block;
      color:var(--muted);
      font-weight:600;
      margin-top:4px;
      font-size:12px;
    }

    .note{
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
      margin-top:10px;
    }
    .err{
      color: var(--danger);
      font-weight:800;
      font-size:13px;
      margin-top:10px;
      display:none;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 640px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }
    .scorebox{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius: 14px;
      padding:12px;
    }
    .scorebox .k{ color:var(--muted); font-size:12px; font-weight:800; }
    .scorebox .v{ font-size:18px; font-weight:900; margin-top:4px; }
    .hint15{
      font-size:12px;
      color: var(--muted);
      margin-top:8px;
    }
    .sectionTitle{
      font-size:14px;
      font-weight:900;
      margin:0 0 10px;
      color: var(--text);
      letter-spacing:.02em;
    }
    .descItem{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:12px;
      line-height:1.7;
    }
    .descItem .head{
      font-weight:900;
      margin-bottom:6px;
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="あなたの考え方のクセを知ろうテスト">
    <header>
      <p class="title" id="headerTitle">あなたの考え方のクセを知ろうテスト</p>
      <p class="sub" id="headerSub">設問１～19について、自分の傾向に当てはまるものに〇を付けましょう</p>
    </header>

    <main id="root"></main>
  </div>

<script>

// --- Chart.js loader (prefer local file, fallback to CDN) ---
let __chartJsPromise = null;
function loadChartJs(){
  if (window.Chart) return Promise.resolve();
  if (__chartJsPromise) return __chartJsPromise;

  __chartJsPromise = new Promise((resolve, reject) => {
    const tryLocal = document.createElement("script");
    tryLocal.src = "./chart.umd.min.js";
    tryLocal.defer = true;

    tryLocal.onload = () => resolve();
    tryLocal.onerror = () => {
      const cdn = document.createElement("script");
      cdn.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
      cdn.defer = true;
      cdn.onload = () => resolve();
      cdn.onerror = () => reject(new Error("Chart.js を読み込めませんでした（ローカル/CDNとも失敗）"));
      document.head.appendChild(cdn);
    };

    document.head.appendChild(tryLocal);
  });

  return __chartJsPromise;
}

const QUESTIONS = [
  "証拠もないのに、自分に不利な結論を引き出すことがある。",
  "何か友達とトラブルがあると「友達が私を嫌いになった。」と感じてしまうほうである。",
  "証拠もないのに、悲観的な結論を出してしまうことがある。",
  "ちょっとした小さな失敗をしても、完全な失敗だと感じるほうである。",
  "自分に関係がないとわかっていることでも、自分に関連づけて考えるほうである。",
  "他人の成功や長所は過大に考え、他人の失敗や短所は過小評価するほうである。",
  "物事は完璧か惨敗のどちらかしかない、といった具合に極端に考えるほうである。",
  "自分に不利なことは、些細なことでも気になるほうである。",
  "何か良い出来事があっても、それを無視してしまっていることがある。",
  "何か悪いことが一度自分に起こると、何度も繰り返して起こるように感じるほうである。",
  "たったひとつでも良くないことがあると、世の中すべてそうだと感じてしまう。",
  "わずかな経験から、広範囲のことを恣意的に結論してしまうほうである。",
  "物事を極端に白か黒のどちらかに分けて考えるほうである。",
  "根拠もないのに、人が私に悪く反応したと早合点してしまうことがある。",
  "自分の失敗や短所は過大に考え、自分の成功や長所は過小評価するほうである。",
  "ちょっとした小さな成功をすると、完全な成功だと感じるほうである。",
  "たったひとつでも良くないことにこだわってしまいそればかりクヨクヨと考えるほうである。",
  "何か悪いことが起こると、自分のせいであるかのように考えてしまう。",
  "はっきりした根拠がないのに、「これから状況は必ず悪くなる」と考えてしまうことがある。"
];

const LIKERT = [
  { v: 1, label: "１：全くあてはまらない" },
  { v: 2, label: "２：あまりあてはまらない" },
  { v: 3, label: "３：ややあてはまる" },
  { v: 4, label: "４：全くあてはまる" }
];

const MAP = {
  A: [1,3,14,19],
  B: [8,9,17],
  C: [2,4,10,11,12,16],
  D: [6,15],
  E: [5,18],
  F: [7,13]
};

const MULT = { A:1.5, B:2, C:1, D:3, E:3, F:3 };

const NAMES = {
  A:"A：すべて自分が悪いという思い込み",
  B:"B：0か100か思考",
  C:"C：外的環境への諦め",
  D:"D：謙遜と自己否定",
  E:"E：感情による理由づけ",
  F:"F：不平等への過度な嫌悪"
};

const EXPLAIN = {
  A:"あなたは、少しでも心配なことや気がかりなことがあると、それがどんどん悪いほうに発展してしまうかのような想像を次々とめぐらせ、その結果、不安になったり、落ち込んだりする、自分のこころの読み過ぎる傾向があるようです。",
  B:"多くの仕事をこなしているのに、できなかった少しの仕事にばかり気をとられて、自尊感情が低下したり、不安になったりする傾向があるようです。",
  C:"「自分はダメなやつだ」「自分は弱い人間だ」といったように、自分に否定的なラベルを貼り、それを繰り返しイメージすることで、さらに悲しい気持ちになっていく傾向があるようです。",
  D:"自分が気にしていることに少しでもあてはまるような出来事に出会うと「ああ、やっぱりそうだ」とすべてを物語る証拠のように思い込んでしまうクセがついているようです。",
  E:"うまくいかない状態の理由を、何でも自分の能力や性格特徴などに結びつけて考えてしまい、自分以外の要素に目を向けることが苦手な傾向があるようです。",
  F:"物事を両極端に考えてしまい、少しでも良くない点や気になる点があると、それはすべて「失敗」「ダメ」と思ってしまう完璧主義思考が強いようです。"
};

const SCALE_MIN = 0;
const SCALE_MAX = 25;
const THRESHOLD = 15;

let state = {
  screen: "home",
  qIndex: 0,
  answers: Array(QUESTIONS.length).fill(null),
  scores: null
};

const root = document.getElementById("root");

function setHeader(title, sub){
  document.getElementById("headerTitle").textContent = title;
  document.getElementById("headerSub").textContent = sub || "";
}
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function calcScores(){
  const sums = {};
  for (const k of Object.keys(MAP)){
    const sum = MAP[k].reduce((acc, qn)=>{
      const v = state.answers[qn-1];
      return acc + (Number.isFinite(v) ? v : 0);
    }, 0);
    sums[k] = sum * MULT[k];
  }
  return sums;
}
function firstUnansweredIndex(){
  const i = state.answers.findIndex(v => v === null);
  return i === -1 ? 0 : i;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function formatScore(n){
  if (!Number.isFinite(n)) return "0";
  return (Math.round(n*10)/10).toString();
}
function persist(){
  try{ localStorage.setItem("kuse_test_state", JSON.stringify(state)); }catch(e){}
}

/**
 * Restore saved answers/state from localStorage.
 * Fix: Always start from home screen when the app launches.
 */
function restore(){
  try{
    const s = localStorage.getItem("kuse_test_state");
    if (!s) return;
    const obj = JSON.parse(s);
    if (!obj || !Array.isArray(obj.answers) || obj.answers.length !== QUESTIONS.length) return;

    state = { ...state, ...obj };

    // ★ Always start at Home screen on launch
    state.screen = "home";
  }catch(e){}
}

function render(){
  if (state.screen === "home") return renderHome();
  if (state.screen === "question") return renderQuestion();
  if (state.screen === "result") return renderResult();
  if (state.screen === "tendency") return renderTendency();
}

function renderHome(){
  setHeader("あなたの考え方のクセを知ろうテスト", "設問１～19について、自分の傾向に当てはまるものに〇を付けましょう");
  root.innerHTML = `
    <div class="card">
      <div class="pill">回答は端末内に保存されます</div>
      <div class="spacer"></div>
      <p style="margin:0; color:var(--muted); line-height:1.7;">
        設問1〜19について、当てはまる数字を選んでください。
      </p>
      <div class="spacer"></div>
      <button class="btn" id="startBtn">スタート</button>
      <div class="spacer"></div>
      <button class="btn secondary" id="continueBtn">途中から続ける</button>
      <div class="spacer"></div>
      <button class="btn danger" id="resetBtn">最初からやり直す（回答を消去）</button>
      <p class="note">※回答データはサーバー送信しません（ローカル保存のみ）。</p>
    </div>
  `;

  document.getElementById("startBtn").onclick = () => {
    state.answers = Array(QUESTIONS.length).fill(null);
    state.scores = null;
    state.qIndex = 0;
    state.screen = "question";
    persist();
    render();
  };
  document.getElementById("continueBtn").onclick = () => {
    state.screen = "question";
    state.qIndex = firstUnansweredIndex();
    render();
  };
  document.getElementById("resetBtn").onclick = () => {
    state = { screen:"home", qIndex:0, answers:Array(QUESTIONS.length).fill(null), scores:null };
    try{ localStorage.removeItem("kuse_test_state"); }catch(e){}
    render();
  };
}

function renderQuestion(){
  const qn = state.qIndex + 1;
  setHeader(`Q${qn} / ${QUESTIONS.length}`, "あてはまるものを1つ選んでください");
  const current = state.answers[state.qIndex];

  root.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <span class="pill">Q${qn}</span>
        <span class="pill">進捗：${qn} / ${QUESTIONS.length}</span>
      </div>

      <p class="qtext">${escapeHtml(QUESTIONS[state.qIndex])}</p>

      <div class="choices">
        ${LIKERT.map(opt => `
          <label class="choice ${current===opt.v ? "selected":""}">
            <input type="radio" name="likert" value="${opt.v}" ${current===opt.v ? "checked":""} />
            <div>
              <span class="label">${opt.label}</span>
              <span class="small">選択してから「つぎの設問へ」を押してください</span>
            </div>
          </label>
        `).join("")}
      </div>

      <div class="err" id="err">※どれか1つ選択してください</div>

      <div class="spacer"></div>
      <div class="grid2">
        <button class="btn secondary" id="backBtn" ${state.qIndex===0 ? "disabled":""}>前の設問へ</button>
        <button class="btn" id="nextBtn">${qn===QUESTIONS.length ? "集計して結果へ" : "つぎの設問へ"}</button>
      </div>

      <div class="spacer"></div>
      <button class="btn danger" id="homeBtn">ホームへ戻る</button>
    </div>
  `;

  const radios = root.querySelectorAll('input[name="likert"]');
  radios.forEach(r => {
    r.addEventListener("change", () => {
      state.answers[state.qIndex] = Number(r.value);
      persist();
      root.querySelectorAll(".choice").forEach(c => c.classList.remove("selected"));
      r.closest(".choice").classList.add("selected");
      document.getElementById("err").style.display = "none";
    });
  });

  document.getElementById("backBtn").onclick = () => {
    if (state.qIndex > 0) state.qIndex -= 1;
    render();
  };
  document.getElementById("nextBtn").onclick = () => {
    const v = state.answers[state.qIndex];
    if (!Number.isFinite(v)){
      document.getElementById("err").style.display = "block";
      return;
    }
    if (state.qIndex < QUESTIONS.length - 1){
      state.qIndex += 1;
      render();
    } else {
      state.scores = calcScores();
      persist();
      state.screen = "result";
      render();
    }
  };
  document.getElementById("homeBtn").onclick = () => {
    state.screen = "home";
    render();
  };
}

let radarChart = null;

function renderResult(){
  setHeader("結果（レーダーチャート）", "6項目の合計点（0〜25点）で表示します");
  if (!state.scores) state.scores = calcScores();

  const raw = state.scores;
  const data = ["A","B","C","D","E","F"].map(k => clamp(raw[k], SCALE_MIN, SCALE_MAX));

  root.innerHTML = `
    <div class="card">
      <p class="sectionTitle">あなたの考え方のクセ（0〜25）</p>
      <div style="background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:14px; padding:12px;">
        <canvas id="radar" aria-label="レーダーチャート" role="img" height="260"></canvas>
      </div>

      <div class="spacer"></div>
      <div class="grid2">
        <button class="btn secondary" id="backToQ">設問に戻る</button>
        <button class="btn" id="toTendency">あなたの傾向</button>
      </div>

      <div class="spacer"></div>
      <p class="hint15">※各項目が15点以上の場合、その項目の解説を表示します（15点未満のみの場合は「バランスがとれた考え方」と表示）。</p>

      <div class="spacer"></div>
      <div class="grid2">
        ${["A","B","C","D","E","F"].map(k => `
          <div class="scorebox">
            <div class="k">${NAMES[k]}</div>
            <div class="v">${formatScore(raw[k])}点 <span style="font-size:12px; color:var(--muted); font-weight:800;">（表示:${clamp(raw[k],0,25)}）</span></div>
          </div>
        `).join("")}
      </div>

      <div class="spacer"></div>
      <button class="btn danger" id="homeBtnR">ホームへ戻る</button>
    </div>
  `;

  document.getElementById("backToQ").onclick = () => {
    state.screen = "question";
    state.qIndex = firstUnansweredIndex();
    render();
  };
  document.getElementById("toTendency").onclick = () => {
    state.screen = "tendency";
    render();
  };
  document.getElementById("homeBtnR").onclick = () => {
    state.screen = "home";
    render();
  };

  const ctx = document.getElementById("radar");
  if (radarChart) radarChart.destroy();


  // Chart.js を（ローカル優先で）読み込み
  loadChartJs().then(() => {
    radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: [
        "すべて自分が悪いという思い込み",
        "0か100か思考",
        "外的環境への諦め",
        "謙遜と自己否定",
        "感情による理由づけ",
        "不平等への過度な嫌悪"
      ],
      datasets: [{ label: "スコア（0〜25）", data }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { r: { min: SCALE_MIN, max: SCALE_MAX, ticks: { stepSize: 5 }, grid: { circular: true } } },
      plugins: { legend: { display: false } }
    }
  });
  }).catch((err) => {
    console.error(err);
    const wrap = document.getElementById("radar")?.parentElement;
    if (wrap) wrap.insertAdjacentHTML("beforeend", `<p class="note" style="color:var(--danger); font-weight:800;">${err.message}</p>`);
  });
}

function renderTendency(){
  setHeader("あなたの傾向", "15点以上の項目のみ解説します");
  if (!state.scores) state.scores = calcScores();
  const over = ["A","B","C","D","E","F"].filter(k => state.scores[k] >= THRESHOLD);

  root.innerHTML = `
    <div class="card">
      <p class="sectionTitle">解説</p>
      ${
        over.length === 0
        ? `<div class="descItem">
             <div class="head" style="color:var(--ok);">あなたはバランスのとれた考え方をしています</div>
             <div style="color:var(--muted); font-weight:700;">どの項目も15点未満でした。</div>
           </div>`
        : over.map(k => `
            <div class="descItem" style="margin-top:10px;">
              <div class="head">${NAMES[k]}（${formatScore(state.scores[k])}点）</div>
              <div>${escapeHtml(EXPLAIN[k])}</div>
            </div>
          `).join("")
      }
      <div class="spacer"></div>
      <button class="btn secondary" id="backRadar">レーダーチャート</button>
      <div class="spacer"></div>
      <button class="btn danger" id="homeBtnT">ホームへ戻る</button>
    </div>
  `;

  document.getElementById("backRadar").onclick = () => { state.screen = "result"; render(); };
  document.getElementById("homeBtnT").onclick = () => { state.screen = "home"; render(); };
}

restore();
render();
</script>
</body>
</html>
